@{
    ViewData["Title"] = "Órdenes Listas para Planear";
}

<div class="container-fluid mt-3 px-2">
    <h2 class="mb-4 text-primary fw-bold">
        Órdenes listas para planear
    </h2>
    <hr />

    <form id="frmReadyOrders" class="row g-3">

        <div class="col-md-3">
            <label for="PtoAlm" class="form-label">Almacén</label>
            <select id="PtoAlm" class="form-select" required>
                <option value="870" selected>Vallejo</option>
            </select>
        </div>

        <div class="col-md-3">
            <label for="FecEnt" class="form-label">Fecha de Entrega</label>
            <input type="date" id="FecEnt" name="FecEnt" class="form-control" required />
        </div>

        <div class="col-md-3">
            <label for="TipEnt" class="form-label">Tipo de Entrega</label>
            <select id="TipEnt" name="TipEnt" class="form-select" required>
                <option value="">Seleccione...</option>
                <option value="L" selected>Local</option>
                <option value="F">Foraneo</option>
            </select>
        </div>

        <div class="col-md-3 align-self-end">
            <button type="button" id="btnBuscar" class="btn btn-primary w-100">
                Buscar
            </button>
        </div>
    </form>

    <div id="SendContainer" class="mt-4"></div>

</div>

<div id="loadingOverlay" style="
    display:none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
">
    <div class="spinner" style="
        width: 60px;
        height: 60px;
        border: 8px solid #eee;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    "></div>
    <button id="btnCancelAjax" class="btn btn-danger mt-3">Cancelar</button>
</div>

<div id="sendOverlay" style="
    display:none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
">
    <div class="spinner" style="
        width: 60px;
        height: 60px;
        border: 8px solid #eee;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    "></div>
</div>

@section Styles {
    <style>
        @@keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
}

@section Scripts {
    <script>
        let currentRequest = null;

        function showLoader() {
            $("#loadingOverlay").css("display", "flex");
        }
        function hideLoader() {
            $("#loadingOverlay").hide();
        }

        $("#btnCancelAjax").on("click", function () {
            if (currentRequest) {
                currentRequest.abort();
                hideLoader();
            }
        });

        function showSend() {
            $("#sendOverlay").css("display", "flex");
        }
        function hideSend() {
            $("#sendOverlay").hide();
        }

        function updateSelectedCount() {
            const count = $('#tblReadyOrders tbody .chkIsReady:checked').length;
            $('#selectedCount').text(`${count} registros seleccionados`);
        }

        $(document).on('change', '.chkIsReady', function () {
            updateSelectedCount();
        });

        $("#btnBuscar").click(function () {

            const rawDate = $("#FecEnt").val();
            if (!rawDate) {
                alert("Debe seleccionar una fecha de entrega.");
                return;
            }

            const [year, month, day] = rawDate.split("-");
            const formattedDate = `${day}${month}${year}`;

            var data = {
                PtoAlm: $("#PtoAlm").val(),
                FecEnt: formattedDate,
                TipEnt: $("#TipEnt").val()
            };

            if (!data.PtoAlm || !data.FecEnt || !data.TipEnt) {
                alert("Complete todos los campos antes de continuar.");
                return;
            }

            showLoader();

            currentRequest = $.ajax({
                url: '@Url.Action("GetOrdersPerDate", "DeliveryPlanner")',
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (result) {

                    hideLoader();

                    $("#SendContainer").empty();

                    if (result.length === 0) {
                        $("#SendContainer").html(`
                            <div class="alert alert-warning text-center">
                                No se encontraron resultados
                            </div>
                        `);
                        return;
                    }

                    let html = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div id="selectedCount" class="fw-bold text-primary">
                                0 registros seleccionados
                            </div>

                            <div class="mx-3" style="width: 200px;">
                                <label for="txtNumRutas" class="form-label fw-bold mb-1">Rutas:</label>
                                <input type="number" id="txtNumRutas" class="form-control" min="1"
                                       value="5" placeholder="Número" />
                            </div>

                            <button id="btnSendReady" class="btn btn-success">
                                <i class="bi bi-send"></i> Enviar seleccionados
                            </button>
                        </div>

                        <table id="tblReadyOrders" class="table table-striped table-bordered">
                            <thead class="table-primary">
                                <tr>
                                    <th>Listo</th>
                                    <th>SCN</th>
                                    <th>Orden WMS</th>
                                    <th>Estatus WMS</th>
                                    <th>Estatus GNX</th>
                                    <th>Estado</th>
                                    <th>Municipio</th>
                                    <th>Sector</th>
                                    <th>Codigo Postal</th>
                                    <th>Panel</th>
                                    <th>Volado</th>
                                    <th>Mas Gente</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    $.each(result, function (i, item) {

                        const gnx = (item.gnxEst || "").trim().toLowerCase();

                        const isBlocked =
                            (item.sector === "XXX" && item.tipEnt === "L") ||
                            (item.wmsEst !== "Creado")||
                            (gnx !== "impreso" && gnx !== "transito-retenido");

                        const rowClass = isBlocked ? "text-danger" : "";
                        const disabledAttr = isBlocked ? "disabled" : "";

                        html += `
                            <tr class="${rowClass}"
                                data-scn="${item.numScn}"
                                data-codpto="${item.codPto}"
                                data-wmsest="${item.wmsEst}"
                                data-gnxest="${item.gnxEst}"
                                data-ptoalm="${item.ptoAlm}"
                                data-edocli="${item.edoCli}"
                                data-muncli="${item.munCli}"
                                data-sector="${item.sector}"
                                data-cpcli="${item.cpCli}"
                                data-panel="${item.panel}"
                                data-volado="${item.volado}"
                                data-masgen="${item.masGen}"
                                data-tipent="${item.tipEnt}"
                                data-ordrel="${item.ordRel}"
                                data-fecent="${item.fecEnt}">
                                <td class="text-center">
                                    <input type="checkbox" class="chkIsReady"
                                        ${item.isReady ? 'checked' : ''} ${disabledAttr} />
                                </td>
                                <td>${item.numScn}</td>
                                <td>${item.ordRel}</td>
                                <td>${item.wmsEst}</td>
                                <td>${item.gnxEst}</td>
                                <td>${item.edoCli}</td>
                                <td>${item.munCli}</td>
                                <td>${item.sector}</td>
                                <td>${item.cpCli}</td>
                                <td>${item.panel}</td>
                                <td>${item.volado}</td>
                                <td>${item.masGen}</td>
                            </tr>
                        `;
                    });

                    html += `
                            </tbody>
                        </table>
                    `;

                    $("#SendContainer").html(html);

                    $("#tblReadyOrders").DataTable({
                        order: [],
                        columnDefs: [{ orderable: false, targets: 0 }],
                        pageLength: -1,
                        lengthMenu: [[10, 100, 250, 500, -1], [10, 100, 250, 500, "Todos"]],
                        language: {
                            search: "Buscar:",
                            lengthMenu: "Mostrar _MENU_ registros",
                            info: "Mostrando _START_ a _END_ de _TOTAL_",
                            paginate: {
                                previous: "Anterior",
                                next: "Siguiente"
                            },
                            zeroRecords: "No se encontraron registros"
                        },
                        drawCallback: function () {
                            updateSelectedCount();
                        }
                    });

                     updateSelectedCount();
                },
                error: function (xhr, status) {
                    hideLoader();
                    if (status === "abort") return;

                    Swal.fire({
                        icon: 'error',
                        title: 'Error del servidor',
                        text: xhr.responseText || xhr.statusText
                    });
                }
            });
        });


        $(document).on('click', '#btnSendReady', function () {

            const selected = [];

            $('#tblReadyOrders tbody tr').each(function () {
                const chk = $(this).find('.chkIsReady');
                if (chk.is(':checked')) {
                    selected.push({
                        IsReady: true,
                        CodPto: String($(this).data('codpto')),
                        NumScn: $(this).data('scn'),
                        WmsEst: $(this).data('wmsest'),
                        GnxEst: $(this).data('gnxest'),
                        PtoAlm: String($(this).data('ptoalm')),
                        EdoCli: $(this).data('edocli'),
                        MunCli: $(this).data('muncli'),
                        Sector: $(this).data('sector'),
                        CpCli: String($(this).data('cpcli')),
                        Panel: $(this).data('panel'),
                        Volado: $(this).data('volado'),
                        MasGen: $(this).data('masgen'),
                        TipEnt: $(this).data('tipent'),
                        OrdRel: String($(this).data('ordrel')),
                        FecEnt: String($(this).data('fecent'))
                    });
                }
            });

            if (selected.length === 0) {
                alert('Selecciona al menos un pedido antes de enviar.');
                return;
            }

            const numRutas = parseInt($("#txtNumRutas").val(), 10);

            const payload = {
                routes: numRutas,
                planInfoList: selected
            };

            showSend();

            $.ajax({
                url: '@Url.Action("SendToRoute", "DeliveryPlanner")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (response) {

                    $('#tblReadyOrders tbody').empty();
                    hideSend();

                    Swal.fire({
                        icon: response.correct ? 'success' : 'warning',
                        title: response.correct ? 'Exitoso' : 'Error',
                        text: response.message
                    });
                },
                error: function (xhr) {
                    hideSend();
                    // console.log(xhr);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error del servidor',
                        text: xhr.responseText || xhr.statusText
                    });
                }
            });
        });


    </script>
}
