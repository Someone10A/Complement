@model List<ML.Operator.RouteHeader>

@{
    ViewData["Title"] = "Ruta Asignada";
}

<div class="container mt-3">

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info text-center">
            No tienes rutas asignadas.
        </div>
    }
    else
    {
        foreach (var route in Model)
        {
            <div class="card mb-3 route-card" data-route='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(route))' style="cursor:pointer;">
                <div class="card-body" data-descripcion="@route.Descripcion">
                    <h5 class="card-title fw-bold"> @route.CarSal </h5>
                    <p class="mb-1"> <strong>Fecha carga:</strong> @route.FecCar </p>
                    <p class="mb-1"> <strong>Descripción:</strong> @route.Descripcion </p>
                    <p class="mb-0"> <strong>Operador:</strong> @route.NomOpe </p>

                    <div class="mt-3 d-flex align-items-center">
                        <div class="flex-grow-1"></div>
                        @if (route.Estatus == "0")
                        {
                            <button class="btn btn-primary btn-accept">Aceptar Ruta</button>
                        }
                        @if (route.Estatus == "2")
                        {
                            <button class="btn btn-warning btn-finish">Finalizar Ruta</button>
                        }
                    </div>
                </div>
            </div>
        }
    }

</div>

<form id="routeForm" method="post" asp-controller="Operator" asp-action="GetOrdersPerRoute">
    <input type="hidden" name="routeJson" id="routeJson" />
</form>

<div id="overlay" class="overlay d-none">
    <div class="spinner-border text-light"></div>
</div>

@section Styles {
    <style>
        .route-card {
            position: relative;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .card-body {
            border-left: 5px solid transparent;
            border-radius: 0.7rem;
            padding: 1rem;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
        }

            .card-body .d-flex {
                justify-content: flex-end;
                align-items: center;
            }

        .route-card:hover .card-body {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .route-asignada {
            border-left-color: #6c757d;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .route-cerrada {
            border-left-color: #87CEFA;
            background: linear-gradient(135deg, #E0F7FF, #B3ECFF);
        }


        .route-abierta {
            border-left-color: #ff922b;
            background: linear-gradient(135deg, #fff4e6, #ffe8cc);
        }

        .route-finalizada {
            border-left-color: #198754;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
        }

        .route-no-listado {
            border-left-color: #f08080;
            background: linear-gradient(135deg, #fce8e8, #f5c2c2);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
}

@section Scripts {
    <script>
        function normalize(text) { return (text||'').trim().toLowerCase(); }
        function getRouteClass(descripcion){
            const desc = normalize(descripcion);
            if(desc.includes('asignada')) return 'route-asignada';
            if(desc.includes('cerrada')) return 'route-cerrada';
            if(desc.includes('abierta')) return 'route-abierta';
            if(desc.includes('finalizada')) return 'route-finalizada';
            if(desc.includes('no listado')) return 'route-no-listado';
            return 'route-asignada';
        }
        function showOverlay(show){ document.getElementById('overlay').classList.toggle('d-none', !show); }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.card-body').forEach(body => {
                body.classList.add(getRouteClass(body.dataset.descripcion));
            });

            document.querySelectorAll('.route-card').forEach(card => {
                card.addEventListener('click', e => {
                    if(e.target.tagName === 'BUTTON') return;

                    const route = JSON.parse(card.dataset.route);
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = '/Operator/GetOrdersPerRoute';
                    form.style.display = 'none';

                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'routeJson';
                    input.value = JSON.stringify(route);
                    form.appendChild(input);

                    document.body.appendChild(form);
                    form.submit();
                });
            });

            document.querySelectorAll('.btn-accept').forEach(btn=>{
                btn.addEventListener('click', e=>{
                    e.stopPropagation();
                    const route = JSON.parse(btn.closest('.route-card').dataset.route);
                    Swal.fire({title:'¿Aceptar ruta?', icon:'question', showCancelButton:true, confirmButtonText:'Sí, aceptar'})
                    .then(result=>{
                        if(result.isConfirmed){
                            showOverlay(true);
                            fetch('@Url.Action("AcceptRoute", "Operator")',{
                                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(route)
                            }).then(r=>r.json()).then(r=>{
                                showOverlay(false);
                                Swal.fire(r.message).then(()=>location.reload());
                            });
                        }
                    });
                });
            });

            document.querySelectorAll('.btn-finish').forEach(btn=>{
                btn.addEventListener('click', e=>{
                    e.stopPropagation();
                    const route = JSON.parse(btn.closest('.route-card').dataset.route);
                    Swal.fire({title:'¿Finalizar ruta?', icon:'warning', showCancelButton:true, confirmButtonText:'Sí, finalizar'})
                    .then(result=>{
                        if(result.isConfirmed){
                            showOverlay(true);
                            fetch('@Url.Action("FinishRoute", "Operator")',{
                                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(route)
                            }).then(r=>r.json()).then(r=>{
                                showOverlay(false);
                                Swal.fire(r.message).then(()=>location.reload());
                            });
                        }
                    });
                });
            });
        });
    </script>
}
