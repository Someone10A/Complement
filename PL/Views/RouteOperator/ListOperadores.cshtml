@model List<ML.RouteOperator.Operador>
@{
    ViewData["Title"] = "Operadores";
}

<div class="container-fluid mt-1 px-2">
    <h2 class="mb-4 text-primary fw-bold">Operadores</h2>
    <hr />

    <form id="token-form" style="display: none;">
        @Html.AntiForgeryToken()
    </form>

    @if (!string.IsNullOrEmpty(ViewBag.Error))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @ViewBag.Error
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fs-6 fw-semibold">
                <i class="bi bi-person-plus"></i> Agregar Nuevo Operador
            </h5>
            <button type="button" class="btn btn-sm btn-light" id="btnResetPassword" title="Reestablecer contraseña">
                <i class="bi bi-key"></i> Reestablecer Contraseña
            </button>
        </div>
        <div class="card-body">
            <form id="addOperadorForm" class="row g-3">
                @Html.AntiForgeryToken()
                <div class="col-md-4">
                    <label for="rfc_ope" class="form-label">RFC</label>
                    <input type="text" class="form-control" id="rfc_ope" name="rfc_ope" maxlength="15" />
                </div>
                <div class="col-md-4">
                    <label for="nom_ope" class="form-label">Nombre <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="nom_ope" name="nom_ope" maxlength="40" required />
                </div>
                <div class="col-md-4">
                    <label for="password" class="form-label">Contraseña <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="password" name="password" maxlength="16" required />
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Agregar Operador
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de operadores -->
    <div class="card shadow-sm">
        <div class="card-header bg-light border-bottom">
            <h5 class="mb-0 fs-6 fw-semibold text-secondary">
                <i class="bi bi-people"></i> Lista de Operadores
            </h5>
        </div>
        <div class="card-body" id="tablaOperadoresContainer">
            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover table-bordered table-striped align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>RFC</th>
                                <th>Nombre</th>
                                <th class="text-center">Activo</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var operador in Model)
                            {
                                <tr>
                                    <td>@(operador.rfc_ope ?? "-")</td>
                                    <td>@operador.nom_ope</td>
                                    <td class="text-center">
                                        <div class="form-check form-switch d-inline-block">
                                            <input class="form-check-input active-toggle" 
                                                   type="checkbox" 
                                                   role="switch" 
                                                   data-cod-emp="@operador.cod_emp"
                                                   data-rfc-ope="@(operador.rfc_ope ?? "")"
                                                   @(operador.active == "1" ? "checked" : "") 
                                                   style="width: 3rem; height: 1.5rem; cursor: pointer;">
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    No se encontraron operadores.
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal para Reestablecer Contraseña -->
<div class="modal fade" id="modalResetPassword" tabindex="-1" aria-labelledby="modalResetPasswordLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalResetPasswordLabel">
                    <i class="bi bi-key"></i> Reestablecer Contraseña
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formResetPassword">
                    <div class="mb-3">
                        <label for="reset_rfc_ope" class="form-label">RFC del Operador <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="reset_rfc_ope" name="rfc_ope" maxlength="15" required />
                        <small class="form-text text-muted">Ingrese el RFC del operador para reestablecer su contraseña</small>
                    </div>
                    <div class="mb-3">
                        <label for="reset_new_password" class="form-label">Nueva Contraseña <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="reset_new_password" name="new_password" maxlength="16" required />
                        <small class="form-text text-muted">Ingrese la nueva contraseña (máximo 16 caracteres)</small>
                    </div>
                    <div class="mb-3">
                        <label for="reset_confirm_password" class="form-label">Confirmar Contraseña <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="reset_confirm_password" name="confirm_password" maxlength="16" required />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btnConfirmResetPassword">
                    <i class="bi bi-check-circle"></i> Reestablecer
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function refrescarTablaOperadores() {
            const container = $('#tablaOperadoresContainer');
            container.html('<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>');
            
            $.ajax({
                url: '@Url.Action("ListOperadores", "RouteOperator")',
                type: 'GET',
                dataType: 'html',
                success: function(response) {
                    try {
                        const $temp = $('<div>').html(response);
                        const nuevoContenido = $temp.find('#tablaOperadoresContainer').html();
                        
                        if (nuevoContenido) {
                            container.html(nuevoContenido);
                        } else {
                            location.reload();
                        }
                    } catch (e) {
                        location.reload();
                    }
                },
                error: function(xhr, status, error) {
                    container.html('<div class="alert alert-danger">Error al cargar la tabla. Recargando página...</div>');
                    setTimeout(() => location.reload(), 1500);
                }
            });
        }

        $(document).ready(function() {
            $('.active-toggle').on('change', function() {
                const toggle = $(this);
                const codEmp = toggle.data('cod-emp');
                const rfcOpe = toggle.data('rfc-ope');
                const active = toggle.is(':checked') ? '1' : '0';
                const originalState = !toggle.is(':checked');

                toggle.prop('disabled', true);

                $.ajax({
                    url: '@Url.Action("UpdateActiveStatus", "RouteOperator")',
                    type: 'POST',
                    data: {
                        codEmp: codEmp,
                        rfcOpe: rfcOpe,
                        active: active
                    },
                    headers: {
                        'RequestVerificationToken': $('#token-form input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Éxito',
                                text: response.message || 'Estado actualizado correctamente',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        } else {
                            toggle.prop('checked', originalState);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.message || 'Error al actualizar el estado'
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        toggle.prop('checked', originalState);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al comunicarse con el servidor'
                        });
                    },
                    complete: function() {
                        toggle.prop('disabled', false);
                    }
                });
            });

            $('#addOperadorForm').on('submit', function(e) {
                e.preventDefault();

                const formData = {
                    cod_emp: 1,
                    rfc_ope: $('#rfc_ope').val() || null,
                    nom_ope: $('#nom_ope').val(),
                    password: $('#password').val(),
                    active: '0'
                };

                if (!formData.nom_ope || formData.nom_ope.trim() === '') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Validación',
                        text: 'El nombre es requerido'
                    });
                    return;
                }

                if (!formData.password || formData.password.trim() === '') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Validación',
                        text: 'La contraseña es requerida'
                    });
                    return;
                }

                $.ajax({
                    url: '@Url.Action("AddOperador", "RouteOperator")',
                    type: 'POST',
                    data: formData,
                    headers: {
                        'RequestVerificationToken': $('#token-form input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#addOperadorForm')[0].reset();
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Éxito',
                                text: response.message || 'Operador agregado correctamente',
                                confirmButtonText: 'Aceptar',
                                timer: 2000,
                                showConfirmButton: true
                            }).then(() => {
                                refrescarTablaOperadores();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.message || 'Error al agregar el operador'
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al comunicarse con el servidor'
                        });
                    }
                });
            });

            $('#btnResetPassword').on('click', function() {
                $('#reset_rfc_ope').val('');
                $('#reset_new_password').val('');
                $('#reset_confirm_password').val('');
                
                const modal = new bootstrap.Modal(document.getElementById('modalResetPassword'));
                modal.show();
            });

            $('#btnConfirmResetPassword').on('click', function() {
                const rfcOpe = $('#reset_rfc_ope').val();
                const newPassword = $('#reset_new_password').val();
                const confirmPassword = $('#reset_confirm_password').val();

                if (!rfcOpe || rfcOpe.trim() === '') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Validación',
                        text: 'Ingrese el RFC del operador'
                    });
                    return;
                }

                if (!newPassword || newPassword.trim() === '') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Validación',
                        text: 'Ingrese la nueva contraseña'
                    });
                    return;
                }

                if (newPassword !== confirmPassword) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Validación',
                        text: 'Las contraseñas no coinciden'
                    });
                    return;
                }

                if (newPassword.length > 16) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Validación',
                        text: 'La contraseña no puede tener más de 16 caracteres'
                    });
                    return;
                }

                const btn = $(this);
                btn.prop('disabled', true);
                btn.html('<span class="spinner-border spinner-border-sm" role="status"></span> Procesando...');

                $.ajax({
                    url: '@Url.Action("ResetPassword", "RouteOperator")',
                    type: 'POST',
                    data: {
                        codEmp: 1,
                        rfcOpe: rfcOpe.trim(),
                        newPassword: newPassword.trim()
                    },
                    headers: {
                        'RequestVerificationToken': $('#token-form input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('modalResetPassword'));
                            if (modal) modal.hide();
                            $('#reset_rfc_ope').val('');
                            $('#reset_new_password').val('');
                            $('#reset_confirm_password').val('');
                            btn.prop('disabled', false);
                            btn.html('<i class="bi bi-check-circle"></i> Reestablecer');
                            Swal.fire({
                                icon: 'success',
                                title: 'Éxito',
                                text: response.message || 'Contraseña reestablecida correctamente',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.message || 'Error al reestablecer la contraseña'
                            });
                        }
                        btn.prop('disabled', false);
                        btn.html('<i class="bi bi-check-circle"></i> Reestablecer');
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al comunicarse con el servidor'
                        });
                        btn.prop('disabled', false);
                        btn.html('<i class="bi bi-check-circle"></i> Reestablecer');
                    }
                });
            });
        });
    </script>
}

