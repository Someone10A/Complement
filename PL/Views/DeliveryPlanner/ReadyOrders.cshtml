@{
    ViewData["Title"] = "Órdenes Listas para Planear";
}

<div class="container-fluid mt-3 px-2">
    <h2 class="mb-4 text-primary fw-bold">
        Órdenes listas para planear
    </h2>
    <hr />

    <form id="frmReadyOrders" class="row g-3">

        <!-- Campo visible: selección de almacén -->
        <div class="col-md-3">
            <label for="PtoAlm" class="form-label">Almacén</label>
            <select id="PtoAlm" class="form-select" required>
                <option value="870" selected>Vallejo</option>
            </select>
        </div>

        <div class="col-md-3">
            <label for="FecEnt" class="form-label">Fecha de Entrega</label>
            <input type="date" id="FecEnt" name="FecEnt" class="form-control" required />
        </div>

        <div class="col-md-3">
            <label for="TipEnt" class="form-label">Tipo de Entrega</label>
            <select id="TipEnt" name="TipEnt" class="form-select" required>
                <option value="">Seleccione...</option>
                <option value="L" selected>Local</option>
                <option value="F">Foraneo</option>
            </select>
        </div>

        <div class="col-md-3 align-self-end">
            <button type="button" id="btnBuscar" class="btn btn-primary w-100">
                Buscar
            </button>
        </div>
    </form>

    <div id="SendContainer" class="d-flex justify-content-end mb-3 mt-3" ">
        @* <button id="btnSendReady" class="btn btn-success d-none">
            <i class="bi bi-send"></i> Enviar seleccionados
        </button> *@
    </div>

    <div class="mt-4">
        <table class="table table-striped table-bordered" id="tblReadyOrders">
            <thead class="table-primary">
                <tr>
                    <th>Listo</th>
                    <th>SCN</th>
                    <th>Cliente</th>
                    <th>Estado</th>
                    <th>Sector</th>
                    <th>Codigo Postal</th>
                    <th>Panel</th>
                    <th>Volado</th>
                    <th>Mas Gente</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>

        $("#btnBuscar").click(function () {
            const rawDate = $("#FecEnt").val();
            if (!rawDate) {
                alert("Debe seleccionar una fecha de entrega.");
                return;
            }

            const [year, month, day] = rawDate.split("-");
            const formattedDate = `${day}${month}${year}`;

            var data = {
                PtoAlm: $("#PtoAlm").val(),
                FecEnt: formattedDate,
                TipEnt: $("#TipEnt").val()
            };

            if (!data.PtoAlm || !data.FecEnt || !data.TipEnt) {
                alert("Complete todos los campos antes de continuar.");
                return;
            }

            $.ajax({
                url: '@Url.Action("GetReadyOrdersPerDate", "DeliveryPlanner")',
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (result) {
                    var tbody = $("#tblReadyOrders tbody");
                    tbody.empty();

                    var sendContainer = $("#SendContainer");
                    tbody.empty();

                    if (result.length === 0) {
                        sendContainer.empty();
                        tbody.append('<tr><td colspan="9" class="text-center">No se encontraron resultados</td></tr>');
                        return;
                    }

                    if ($("#btnSendReady").length === 0) {
                        sendContainer.empty();
                        const btn = $('<button>', {
                            id: 'btnSendReady',
                            class: 'btn btn-success'
                        }).append('<i class="bi bi-send"></i> Enviar seleccionados');

                        sendContainer.append(btn);
                    }


                    $.each(result, function (i, item) {
                        tbody.append(`
                            <tr data-scn="${item.numScn}"
                                data-ptoalm="${item.ptoAlm}"
                                data-procli="${item.proCli}"
                                data-pobcli="${item.pobCli}"
                                data-sector="${item.sector}"
                                data-cpcli="${item.cpCli}"
                                data-panel="${item.panel}"
                                data-volado="${item.volado}"
                                data-masgen="${item.masGen}">
                                <td class="text-center">
                                    <input type="checkbox" class="chkIsReady" ${item.isReady ? 'checked' : ''} />
                                </td>
                                <td>${item.numScn}</td>
                                <td>${item.proCli}</td>
                                <td>${item.pobCli}</td>
                                <td>${item.sector}</td>
                                <td>${item.cpCli}</td>
                                <td>${item.panel}</td>
                                <td>${item.volado}</td>
                                <td>${item.masGen}</td>
                            </tr>
                        `);
                    });
                },
                error: function (xhr) {
                    alert("Error: " + xhr.responseText);
                }
            });
        });

        $(document).on('click', '#btnSendReady', function () {
            const selected = [];

            $('#tblReadyOrders tbody tr').each(function () {
                const chk = $(this).find('.chkIsReady');
                if (chk.is(':checked')) {
                    selected.push({
                        NumScn: $(this).data('scn'),
                        PtoAlm: String($(this).data('ptoalm')),
                        ProCli: $(this).data('procli'),
                        PobCli: $(this).data('pobcli'),
                        Sector: $(this).data('sector'),
                        CpCli: $(this).data('cpcli'),
                        Panel: $(this).data('panel'),
                        Volado: $(this).data('volado'),
                        MasGen: $(this).data('masgen'),
                        IsReady: true
                    });
                }
            });

            if (selected.length === 0) {
                alert('Selecciona al menos un pedido antes de enviar.');
                return;
            }
            console.log(JSON.stringify(selected));

            $.ajax({
                url: '@Url.Action("SendReadyOrders", "DeliveryPlanner")',
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(selected),
                success: function () {
                    alert(`Se enviaron ${selected.length} pedidos correctamente.`);
                },
                error: function (xhr) {
                    alert('Error al enviar pedidos: ' + xhr.responseText);
                }
            });
        });

    </script>
}
